<!DOCTYPE html>
<html lang="{{ 'de' if ui_language == 'DE' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zammad Qdrant Interface</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX für dynamische Updates -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    
    <!-- Alpine.js für interaktive Komponenten -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Chart.js für Visualisierungen -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/static/lang.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        /* Custom animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="database" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <h1 class="text-2xl font-bold text-gray-900">Zammad Qdrant Interface</h1>
                            <p class="text-sm text-gray-600">Ticket Transfer & Hybrid Search</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Language Dropdown -->
                        <div class="flex items-center p-2 rounded-lg bg-gray-100">
                            <i data-lucide="globe" class="w-5 h-5 mr-2"></i>
                            <select id="ui-language-select" class="bg-transparent text-sm outline-none">
                                <option value="DE" {{ 'selected' if ui_language == 'DE' else '' }}>DE</option>
                                <option value="EN" {{ 'selected' if ui_language == 'EN' else '' }}>EN</option>
                            </select>
                        </div>
                        <!-- Settings Link -->
                        <a href="/settings" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </a>
                        
                        <!-- Theme Toggle -->
                        <button class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i data-lucide="moon" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Transfer Status Card -->
                <div id="transfer-status-card" class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition-shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i id="transfer-status-icon" data-lucide="upload" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Transfer Status</p>
                            <p class="text-2xl font-bold text-gray-900">Bereit</p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="transfer-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="transfer-status-text" class="text-xs text-gray-500 mt-1">Bereit für Transfer</p>
                    </div>
                </div>

                <!-- BM25 Stats Card -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100">
                            <i data-lucide="search" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">BM25 Vocabulary</p>
                            <p class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <!-- Qdrant Collections Card -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i data-lucide="layers" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Collections</p>
                            <p class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <!-- Search Performance Card -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100">
                            <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Search Performance</p>
                            <p class="text-2xl font-bold text-gray-900">
                                <span class="text-sm text-gray-500">Ready</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Interface -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Transfer Control Panel -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center mb-6">
                        <i data-lucide="settings" class="w-6 h-6 text-gray-600 mr-3"></i>
                        <h2 class="text-xl font-semibold text-gray-900">Transfer Konfiguration</h2>
                    </div>

                    <form class="space-y-4">
                        <!-- BM25 Mode -->
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox"
                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm font-medium text-gray-700">BM25 Cache verwenden</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">
                                Aktiviert schnellen Modus mit vorhandenem BM25-Index
                            </p>
                        </div>

                        <!-- Minimum Age -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Mindestalter für geschlossene Tickets (Tage)
                            </label>
                            <input type="number"
                                   min="0" max="365"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Index Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Tickets indexieren ab Datum
                            </label>
                            <input type="date"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Transfer Button -->
                        <button type="button"
                                id="transfer-button"
                                data-action="start"
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                            <span>Transfer starten</span>
                        </button>
                    </form>

                    <!-- Live Log -->
                    <div class="mt-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Live Log</h3>
                        <div class="bg-gray-50 rounded-lg p-4 h-48 overflow-y-auto text-sm font-mono">
                            <div class="text-gray-600">
                                System bereit für Transfer
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Interface -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center mb-6">
                        <i data-lucide="search" class="w-6 h-6 text-gray-600 mr-3"></i>
                        <h2 class="text-xl font-semibold text-gray-900">Hybrid Search</h2>
                    </div>

                    <!-- Search Form -->
                    <form class="space-y-4">
                        <div class="relative">
                            <input type="text"
                                   placeholder="Suchanfrage eingeben..."
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                    Top K Chunks
                                </label>
                                <input id="top-k-chunks" type="number"
                                       min="10" max="500" value="100"
                                       class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                    Top Tickets
                                </label>
                                <input id="top-tickets" type="number"
                                       min="5" max="50" value="5"
                                       class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            </div>
                        </div>

                        <button id="search-button" type="button"
                                class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                            <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>
                            Hybrid Search ausführen
                        </button>
                    </form>

                    <!-- Search Results -->
                    <div class="mt-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">
                            Suchergebnisse (<span id="search-results-count">0</span>)
                        </h3>
                        <div id="search-results" class="space-y-4 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                Keine Suchergebnisse
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zeitgesteuerte Transfers -->
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <i data-lucide="clock" class="w-6 h-6 text-gray-600 mr-3"></i>
                            <h2 class="text-xl font-semibold text-gray-900">Zeitgesteuerte Transfers</h2>
                        </div>
                        <div class="flex space-x-2">
                            <span id="scheduler-status" class="text-sm px-2 py-1 rounded bg-red-100 text-red-600">● Gestoppt</span>
                            <button id="start-scheduler-btn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                <i data-lucide="play" class="w-3 h-3 inline mr-1"></i>Resume
                            </button>
                            <button id="stop-scheduler-btn" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                <i data-lucide="square" class="w-3 h-3 inline mr-1"></i>Stop
                            </button>
                        </div>
                    </div>

                    <!-- Neuen Zeitplan erstellen -->
                    <form id="schedule-form" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Neuen Zeitplan erstellen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="schedule-name" placeholder="z.B. Täglicher Transfer"
                                       class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Intervall</label>
                                <select id="schedule-interval" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <option value="hourly">Stündlich</option>
                                    <option value="daily" selected>Täglich</option>
                                    <option value="weekly">Wöchentlich</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Uhrzeit (HH:MM)</label>
                                <input type="time" id="schedule-time" value="02:00"
                                       class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            </div>
                            <div id="weekly-days" style="display: none;">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Wochentage</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" value="0" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Mo</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="1" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Di</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="2" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Mi</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="3" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Do</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="4" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Fr</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="5" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">Sa</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="6" class="schedule-day rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        <span class="ml-1 text-xs">So</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="schedule-bm25" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-xs text-gray-700">BM25 Cache verwenden</span>
                            </label>
                        </div>

                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                            <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>Zeitplan erstellen
                        </button>
                    </form>

                    <!-- Geplante Transfers Liste -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Aktive Zeitpläne</h3>
                        <div id="schedules-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8 text-sm">
                                Keine Zeitpläne erstellt
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BM25 Statistics Panel -->
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <i data-lucide="bar-chart-3" class="w-6 h-6 text-gray-600 mr-3"></i>
                            <h2 class="text-xl font-semibold text-gray-900">BM25 Statistiken</h2>
                        </div>
                        <button class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                            Aktualisieren
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-purple-800 mb-2">Vocabulary Size</h3>
                            <p class="text-2xl font-bold text-purple-900">0</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-purple-800 mb-2">Documents</h3>
                            <p class="text-2xl font-bold text-purple-900">0</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-purple-800 mb-2">Avg. Document Length</h3>
                            <p class="text-2xl font-bold text-purple-900">0.0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MCP Server Control Panel -->
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100">
                                <i data-lucide="server" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-xl font-semibold text-gray-900">MCP Server Status</h2>
                                <p class="text-sm text-gray-600">
                                    <span id="mcp-status-indicator" class="text-red-600">● Server gestoppt</span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- MCP Server Control Buttons -->
                        <div class="flex space-x-3">
                            <button class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                                <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                Server starten
                            </button>
                            <button class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                                <i data-lucide="square" class="w-4 h-4 inline mr-2"></i>
                                Server stoppen
                            </button>
                        </div>
                    </div>

                    <!-- MCP Server Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Server-Info</h3>
                            <p class="text-xs text-gray-500 mt-1">
                                URL: <span id="mcp-server-url">-</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Port: <span id="mcp-server-port">-</span>
                            </p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Lokale IP-Adresse</h3>
                            <p class="text-xs text-gray-600">
                                <span id="local-ip-address">Ermittle IP...</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Vollständige URL: <span id="full-mcp-url">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadInitialData();
            startAutoRefresh();
        });

        // Global variables
        let config = {};
        let transferRunning = false;
        let mcpServerRunning = false;
        let autoRefreshInterval;

        // Load initial data
        async function loadInitialData() {
            try {
                // Load config
                const configResponse = await fetch('/api/config');
                config = await configResponse.json();
                
                // Populate form fields
                document.querySelector('input[type="checkbox"]').checked = config.bm25_cache || false;
                document.querySelector('input[type="number"]').value = config.min_age_days || 14;
                document.querySelector('input[type="date"]').value = config.start_date || '2018-01-01';
                
                // Load transfer status
                await updateTransferStatus();
                
                // Load live log
                await updateLiveLog();
                
                // Load MCP server status
                await updateMCPStatus();
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Update transfer status
        async function updateTransferStatus() {
            try {
                const response = await fetch('/api/transfer-status');
                const status = await response.json();
                
                console.log('Transfer status:', status); // Debug log
                transferRunning = status.is_running;
                
                // Get elements by specific IDs
                const statusCard = document.getElementById('transfer-status-card');
                const statusIcon = document.getElementById('transfer-status-icon');
                const progressBar = document.getElementById('transfer-progress-bar');
                const statusText = document.getElementById('transfer-status-text');
                const transferButton = document.getElementById('transfer-button');
                
                if (status.is_running) {
                    console.log('Updating UI: Transfer is running'); // Debug log
                    
                    // Update status card
                    if (statusIcon) {
                        statusIcon.setAttribute('data-lucide', 'loader');
                    }
                    if (statusText) {
                        statusText.textContent = 'Transfer läuft...';
                    }
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.classList.add('pulse-slow');
                    }
                    
                    // Update transfer button
                    if (transferButton) {
                        transferButton.className = 'w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors';
                        transferButton.setAttribute('data-action', 'stop');
                        const icon = transferButton.querySelector('i');
                        const span = transferButton.querySelector('span');
                        if (icon) icon.setAttribute('data-lucide', 'square');
                        if (span) span.textContent = 'Transfer stoppen';
                        console.log('Button updated to red: Transfer stoppen'); // Debug log
                    }
                } else {
                    console.log('Updating UI: Transfer is not running'); // Debug log
                    
                    // Update status card
                    if (statusIcon) {
                        statusIcon.setAttribute('data-lucide', 'check-circle');
                    }
                    if (statusText) {
                        statusText.textContent = 'Bereit für Transfer';
                    }
                    if (progressBar) {
                        progressBar.style.width = '0%';
                        progressBar.classList.remove('pulse-slow');
                    }
                    
                    // Update transfer button
                    if (transferButton) {
                        transferButton.className = 'w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors';
                        transferButton.setAttribute('data-action', 'start');
                        const icon = transferButton.querySelector('i');
                        const span = transferButton.querySelector('span');
                        if (icon) icon.setAttribute('data-lucide', 'play');
                        if (span) span.textContent = 'Transfer starten';
                        console.log('Button updated to blue: Transfer starten'); // Debug log
                    }
                }
                
                // Reinitialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error updating transfer status:', error);
            }
        }

        // Update live log
        async function updateLiveLog() {
            try {
                const response = await fetch('/api/live-log');
                const data = await response.json();
                
                const logContainer = document.querySelector('.bg-gray-50.rounded-lg.p-4.h-48.overflow-y-auto.text-sm.font-mono');
                
                if (data.entries && data.entries.length > 0) {
                    logContainer.innerHTML = data.entries.map(entry => {
                        const levelColor = {
                            'INFO': 'text-blue-600',
                            'WARNING': 'text-yellow-600',
                            'ERROR': 'text-red-600'
                        }[entry.level] || 'text-gray-600';
                        
                        return `<div class="${levelColor}">[${entry.timestamp}] ${entry.level}: ${entry.message}</div>`;
                    }).join('');
                } else {
                    logContainer.innerHTML = '<div class="text-gray-600">Keine Log-Einträge gefunden</div>';
                }
            } catch (error) {
                console.error('Error updating live log:', error);
                const logContainer = document.querySelector('.bg-gray-50.rounded-lg.p-4.h-48.overflow-y-auto.text-sm.font-mono');
                logContainer.innerHTML = '<div class="text-red-600">Fehler beim Laden der Logs</div>';
            }
        }

        // Start transfer
        async function startTransfer() {
            if (transferRunning) {
                alert('Transfer läuft bereits!');
                return;
            }

            const bm25Cache = document.querySelector('input[type="checkbox"]').checked;
            const minAgeDays = parseInt(document.querySelector('input[type="number"]').value) || 14;
            const startDate = document.querySelector('input[type="date"]').value || '2018-01-01';

            const transferConfig = {
                bm25_cache: bm25Cache,
                min_age_days: minAgeDays,
                start_date: startDate
            };

            try {
                const response = await fetch('/api/transfer-start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transferConfig)
                });

                if (response.ok) {
                    await updateTransferStatus();
                    await updateLiveLog();
                } else {
                    const error = await response.json();
                    alert('Fehler beim Starten des Transfers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting transfer:', error);
                alert('Fehler beim Starten des Transfers');
            }
        }

        // Stop transfer
        async function stopTransfer() {
            if (!transferRunning) {
                alert('Kein Transfer läuft!');
                return;
            }

            try {
                const response = await fetch('/api/transfer-stop', {
                    method: 'POST'
                });

                if (response.ok) {
                    await updateTransferStatus();
                    await updateLiveLog();
                } else {
                    const error = await response.json();
                    alert('Fehler beim Stoppen des Transfers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping transfer:', error);
                alert('Fehler beim Stoppen des Transfers');
            }
        }

        // Update BM25 statistics
        async function updateBM25Stats() {
            try {
                const response = await fetch('/api/bm25-stats');
                const data = await response.json();
                
                console.log('BM25 stats:', data); // Debug log
                
                // Update BM25 Vocabulary Card (top dashboard)
                const bm25Card = document.querySelector('#transfer-status-card + div');
                if (bm25Card && data.available) {
                    const vocabularyElement = bm25Card.querySelector('.text-2xl.font-bold');
                    if (vocabularyElement) {
                        vocabularyElement.textContent = data.vocabulary_size.toLocaleString();
                    }
                } else if (bm25Card) {
                    const vocabularyElement = bm25Card.querySelector('.text-2xl.font-bold');
                    if (vocabularyElement) {
                        vocabularyElement.textContent = '0';
                    }
                }
                
                // Update BM25 Statistics Panel (bottom section)
                if (data.available) {
                    // Update Vocabulary Size
                    const vocabElements = document.querySelectorAll('.bg-purple-50 .text-2xl.font-bold');
                    if (vocabElements[0]) {
                        vocabElements[0].textContent = data.vocabulary_size.toLocaleString();
                    }
                    
                    // Update Documents count
                    if (vocabElements[1]) {
                        vocabElements[1].textContent = data.documents.toLocaleString();
                    }
                    
                    // Update Average Document Length
                    if (vocabElements[2]) {
                        vocabElements[2].textContent = data.avg_doc_length.toFixed(1);
                    }
                } else {
                    // Reset to 0 if not available
                    const vocabElements = document.querySelectorAll('.bg-purple-50 .text-2xl.font-bold');
                    if (vocabElements[0]) vocabElements[0].textContent = '0';
                    if (vocabElements[1]) vocabElements[1].textContent = '0';
                    if (vocabElements[2]) vocabElements[2].textContent = '0.0';
                }
                
            } catch (error) {
                console.error('Error loading BM25 stats:', error);
            }
        }

        // Auto refresh
        function startAutoRefresh() {
            // Update every 3 seconds
            autoRefreshInterval = setInterval(async () => {
                await updateTransferStatus();
                await updateLiveLog();
                await updateBM25Stats();
                await updateQdrantCollections();
                await updateMCPStatus();
                await loadSchedules();
                await loadSchedulerStatus();
            }, 3000);
        }

        // Event listeners
        document.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            
            // Transfer button
            if (button && button.id === 'transfer-button') {
                e.preventDefault();
                
                const action = button.getAttribute('data-action');
                if (action === 'start') {
                    startTransfer();
                } else if (action === 'stop') {
                    stopTransfer();
                }
            }
            
            // MCP Server buttons
            if (button && button.textContent.includes('Server starten')) {
                e.preventDefault();
                startMCPServer();
            }
            
            if (button && button.textContent.includes('Server stoppen')) {
                e.preventDefault();
                stopMCPServer();
            }
        });

        // Refresh button for BM25 statistics
        document.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.textContent.includes('Aktualisieren') && button.textContent.includes('BM25')) {
                e.preventDefault();
                updateBM25Stats();
            }
        });

        // Update Qdrant collections
        async function updateQdrantCollections() {
            try {
                const response = await fetch('/api/qdrant-collections');
                const data = await response.json();
                
                console.log('Qdrant collections:', data); // Debug log
                
                // Update Collections Card (dashboard top section)
                const collectionsCard = document.querySelector('#transfer-status-card + div + div');
                if (collectionsCard && data.status === 'connected') {
                    const collectionsElement = collectionsCard.querySelector('.text-2xl.font-bold');
                    if (collectionsElement) {
                        collectionsElement.textContent = data.collections_count;
                    }
                } else if (collectionsCard) {
                    const collectionsElement = collectionsCard.querySelector('.text-2xl.font-bold');
                    if (collectionsElement) {
                        collectionsElement.textContent = '0';
                    }
                }
                
            } catch (error) {
                console.error('Error loading Qdrant collections:', error);
            }
        }

        // Get local IP address
        async function getLocalIP() {
            try {
                // Try to get local IP from network interface
                const response = await fetch('/health');
                const hostname = window.location.hostname;
                
                // If we're accessing via localhost/127.0.0.1, try to get the local IP
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    // Use a simple method to get local IP
                    const pc = new RTCPeerConnection({iceServers: []});
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = function(event) {
                        if (event.candidate) {
                            const ipMatch = event.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                            if (ipMatch && !ipMatch[1].startsWith('127.') && !ipMatch[1].startsWith('0.0.0.')) {
                                const localIP = ipMatch[1];
                                document.getElementById('local-ip-address').textContent = localIP;
                                
                                // Also update full URL
                                const port = data.port || 8083;
                                document.getElementById('full-mcp-url').textContent = `http://${localIP}:${port}`;
                            }
                        }
                        pc.close();
                    };
                } else {
                    // Use the hostname from the URL
                    const localIP = hostname;
                    document.getElementById('local-ip-address').textContent = localIP;
                    const port = data.port || 8083;
                    document.getElementById('full-mcp-url').textContent = `http://${localIP}:${port}`;
                }
            } catch (error) {
                console.log('Could not determine local IP:', error);
                document.getElementById('local-ip-address').textContent = 'Nicht ermittelbar';
            }
        }

        // Update MCP server status
        async function updateMCPStatus() {
            try {
                const response = await fetch('/api/mcp-status');
                const data = await response.json();
                
                console.log('MCP server status:', data); // Debug log
                mcpServerRunning = data.status === 'running';
                
                // Get status indicator by ID
                const statusIndicator = document.getElementById('mcp-status-indicator');
                if (statusIndicator) {
                    if (data.status === 'running') {
                        statusIndicator.textContent = '● Server läuft';
                        statusIndicator.className = 'text-green-600';
                    } else if (data.status === 'starting') {
                        statusIndicator.textContent = '● Server startet...';
                        statusIndicator.className = 'text-yellow-600';
                    } else if (data.status === 'error') {
                        statusIndicator.textContent = '● Server Fehler';
                        statusIndicator.className = 'text-red-600';
                    } else {
                        statusIndicator.textContent = '● Server gestoppt';
                        statusIndicator.className = 'text-red-600';
                    }
                    console.log('Status updated to:', statusIndicator.textContent, 'Class:', statusIndicator.className);
                } else {
                    console.log('Status indicator not found');
                }
                
                // Update Server URL and Port
                const serverUrlElement = document.getElementById('mcp-server-url');
                const serverPortElement = document.getElementById('mcp-server-port');
                const localIPElement = document.getElementById('local-ip-address');
                const fullUrlElement = document.getElementById('full-mcp-url');
                
                // Use new API data fields
                if (data.url_local_ip) {
                    if (serverUrlElement) {
                        serverUrlElement.textContent = data.url_local_ip;
                    }
                    if (localIPElement) {
                        localIPElement.textContent = data.local_ip;
                    }
                    if (fullUrlElement) {
                        fullUrlElement.textContent = data.url_local_ip;
                    }
                } else if (data.url_local) {
                    if (serverUrlElement) {
                        serverUrlElement.textContent = data.url_local;
                    }
                    if (localIPElement) {
                        localIPElement.textContent = data.local_ip;
                    }
                    if (fullUrlElement) {
                        fullUrlElement.textContent = data.url_local;
                    }
                } else {
                    if (serverUrlElement) {
                        serverUrlElement.textContent = 'Nicht verfügbar';
                    }
                    if (localIPElement) {
                        localIPElement.textContent = data.local_ip || 'Unbekannt';
                    }
                    if (fullUrlElement) {
                        fullUrlElement.textContent = '-';
                    }
                }
                
                if (data.port) {
                    if (serverPortElement) {
                        serverPortElement.textContent = data.port;
                    }
                } else {
                    if (serverPortElement) {
                        serverPortElement.textContent = 'Unbekannt';
                    }
                }
                
                // Update MCP Server Control Buttons
                const mcpButtons = document.querySelectorAll('.flex.space-x-3 button');
                if (mcpButtons.length >= 2) {
                    const startButton = mcpButtons[0];
                    const stopButton = mcpButtons[1];
                    
                    if (data.status === 'running') {
                        startButton.disabled = true;
                        startButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed';
                        stopButton.disabled = false;
                        stopButton.className = 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors';
                    } else {
                        startButton.disabled = false;
                        startButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors';
                        stopButton.disabled = true;
                        stopButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed';
                    }
                }
                
                // Reinitialize Lucide icons if needed
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Error updating MCP status:', error);
            }
        }

        // Start MCP server
        async function startMCPServer() {
            if (mcpServerRunning) {
                alert('MCP Server läuft bereits!');
                return;
            }

            try {
                const response = await fetch('/api/mcp-start', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('MCP Server started:', result);
                    await updateMCPStatus();
                    
                    // Show success message
                    alert(`MCP Server erfolgreich gestartet!\n\nURL: ${result.url}\nPort: ${result.port}`);
                } else {
                    const error = await response.json();
                    alert('Fehler beim Starten des MCP Servers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting MCP server:', error);
                alert('Fehler beim Starten des MCP Servers');
            }
        }

        // Stop MCP server
        async function stopMCPServer() {
            if (!mcpServerRunning) {
                alert('MCP Server läuft nicht!');
                return;
            }

            try {
                const response = await fetch('/api/mcp-stop', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('MCP Server stopped:', result);
                    await updateMCPStatus();
                    alert('MCP Server erfolgreich gestoppt');
                } else {
                    const error = await response.json();
                    alert('Fehler beim Stoppen des MCP Servers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping MCP server:', error);
                alert('Fehler beim Stoppen des MCP Servers');
            }
        }

        // Hybrid Search Functions
        async function performHybridSearch() {
            const searchInput = document.querySelector('input[placeholder="Suchanfrage eingeben..."]');
            const topKChunks = document.getElementById('top-k-chunks').value;
            const topTickets = document.getElementById('top-tickets').value;
            const query = searchInput.value.trim();

            if (!query) {
                alert('Bitte geben Sie eine Suchanfrage ein.');
                return;
            }

            if (!mcpServerRunning) {
                alert('MCP Server läuft nicht. Bitte starten Sie den Server zuerst.');
                return;
            }

            try {
                // Use proxy endpoint to avoid CORS issues
                const searchUrl = `/api/search?query=${encodeURIComponent(query)}&top_k=${topKChunks}&top_tickets=${topTickets}`;
                
                console.log('Searching via proxy:', searchUrl); // Debug log
                
                const response = await fetch(searchUrl);
                const data = await response.json();

                if (response.ok) {
                    displaySearchResults(data.results || [], data.query);
                } else {
                    throw new Error(data.error || `HTTP ${response.status}: Search failed`);
                }
            } catch (error) {
                console.error('Error performing search:', error);
                alert('Fehler bei der Suche: ' + error.message);
            }
        }

        function displaySearchResults(results, query) {
            const resultsContainer = document.getElementById('search-results');
            const resultsCount = document.getElementById('search-results-count');

            resultsCount.textContent = results.length;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Keine Suchergebnisse für "${query}" gefunden
                    </div>
                `;
                return;
            }

            // Store results globally to avoid onclick escaping issues
            window.searchResults = results;
            
            resultsContainer.innerHTML = results.map((result, index) => {
                const preview = result.text.length > 300 ? result.text.substring(0, 300) + '...' : result.text;
                return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                     onclick="showTicketPopupByIndex(${index})">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-semibold text-gray-900">
                            Ticket #${result.ticket_id}
                        </h4>
                        <span class="text-sm font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded">
                            Score: ${result.score.toFixed(3)}
                        </span>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed">
                        ${preview.replace(/</g, '<').replace(/>/g, '>')}
                    </p>
                    <div class="mt-2 text-xs text-gray-500">
                        ${result.text.length > 300 ? 'Klicken für vollständigen Text anzuzeigen' : ''}
                    </div>
                </div>
            `;
            }).join('');
        }

        function showTicketPopup(ticketId, score, fullText) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closePopup();
                }
            };

            // Create modal content with safe text handling
            overlay.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="flex justify-between items-center p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900">
                            Ticket #${ticketId}
                        </h2>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-blue-600 bg-blue-100 px-3 py-1 rounded">
                                Score: ${score.toFixed(3)}
                            </span>
                            <button onclick="closePopup()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                        <div class="prose max-w-none">
                            <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono"></pre>
                        </div>
                    </div>
                </div>
            `;

            // Add text content safely after creating the DOM
            const preElement = overlay.querySelector('pre');
            preElement.textContent = fullText;

            document.body.appendChild(overlay);
            
            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Store reference for cleanup
            window.currentPopup = overlay;
        }

        function showTicketPopupByIndex(index) {
            if (window.searchResults && window.searchResults[index]) {
                const result = window.searchResults[index];
                showTicketPopup(result.ticket_id, result.score, result.text);
            } else {
                console.error('Search result not found at index:', index);
            }
        }

        function closePopup() {
            if (window.currentPopup) {
                document.body.removeChild(window.currentPopup);
                window.currentPopup = null;
            }
        }

        // Event listeners for search
        document.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            
            // Search button
            if (button && button.id === 'search-button') {
                e.preventDefault();
                performHybridSearch();
            }
        });

        // Enter key support for search input
        document.addEventListener('keydown', (e) => {
            if (e.target.matches('input[placeholder="Suchanfrage eingeben..."]') && e.key === 'Enter') {
                e.preventDefault();
                performHybridSearch();
            }
        });

        // Scheduling Functions
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();
                displaySchedules(data.schedules || []);
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        function displaySchedules(schedules) {
            const container = document.getElementById('schedules-list');
            
            if (schedules.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8 text-sm">Keine Zeitpläne erstellt</div>';
                return;
            }
            
            container.innerHTML = schedules.map(schedule => {
                const statusColor = schedule.enabled ? 'text-green-600' : 'text-gray-400';
                const statusBg = schedule.enabled ? 'bg-green-100' : 'bg-gray-100';
                const nextRun = schedule.next_run ? new Date(schedule.next_run).toLocaleString('de-DE') : 'Nicht geplant';
                const lastRun = schedule.last_run ? new Date(schedule.last_run).toLocaleString('de-DE') : 'Noch nie';
                
                let intervalText = '';
                switch (schedule.interval) {
                    case 'hourly': intervalText = 'Stündlich'; break;
                    case 'daily': intervalText = `Täglich um ${schedule.time || 'N/A'}`; break;
                    case 'weekly':
                        const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
                        const days = schedule.days ? schedule.days.split(',').map(d => dayNames[parseInt(d)]).join(', ') : 'N/A';
                        intervalText = `Wöchentlich (${days}) um ${schedule.time || 'N/A'}`;
                        break;
                }
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 ${statusBg}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${schedule.name}</h4>
                                <p class="text-xs text-gray-600 mt-1">${intervalText}</p>
                                <div class="flex space-x-4 mt-2 text-xs text-gray-500">
                                    <span>Nächster Lauf: ${nextRun}</span>
                                    <span>Letzter Lauf: ${lastRun}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full ${statusColor.replace('text-', 'bg-')}"></span>
                                <button onclick="toggleSchedule('${schedule.id}', ${!schedule.enabled})"
                                        class="text-xs px-2 py-1 rounded ${schedule.enabled ? 'bg-orange-100 text-orange-600 hover:bg-orange-200' : 'bg-green-100 text-green-600 hover:bg-green-200'}">
                                    ${schedule.enabled ? 'Deaktivieren' : 'Aktivieren'}
                                </button>
                                <button onclick="deleteSchedule('${schedule.id}')"
                                        class="text-xs px-2 py-1 rounded bg-red-100 text-red-600 hover:bg-red-200">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        async function loadSchedulerStatus() {
            try {
                const response = await fetch('/api/schedules/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('scheduler-status');
                const startBtn = document.getElementById('start-scheduler-btn');
                const stopBtn = document.getElementById('stop-scheduler-btn');
                
                if (data.running) {
                    statusElement.textContent = '● Läuft';
                    statusElement.className = 'text-sm px-2 py-1 rounded bg-green-100 text-green-600';
                    startBtn.disabled = true;
                    startBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed';
                    stopBtn.disabled = false;
                    stopBtn.className = 'bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700';
                } else {
                    statusElement.textContent = '● Gestoppt';
                    statusElement.className = 'text-sm px-2 py-1 rounded bg-red-100 text-red-600';
                    startBtn.disabled = false;
                    startBtn.className = 'bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700';
                    stopBtn.disabled = true;
                    stopBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed';
                }
            } catch (error) {
                console.error('Error loading scheduler status:', error);
            }
        }

        async function startScheduler() {
            try {
                const response = await fetch('/api/schedules/start', { method: 'POST' });
                if (response.ok) {
                    await loadSchedulerStatus();
                    await loadSchedules();
                    alert('Scheduler erfolgreich gestartet');
                } else {
                    const error = await response.json();
                    alert('Fehler beim Starten des Schedulers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting scheduler:', error);
                alert('Fehler beim Starten des Schedulers');
            }
        }

        async function stopScheduler() {
            try {
                const response = await fetch('/api/schedules/stop', { method: 'POST' });
                if (response.ok) {
                    await loadSchedulerStatus();
                    alert('Scheduler erfolgreich gestoppt');
                } else {
                    const error = await response.json();
                    alert('Fehler beim Stoppen des Schedulers: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping scheduler:', error);
                alert('Fehler beim Stoppen des Schedulers');
            }
        }

        async function createSchedule(event) {
            event.preventDefault();
            
            const name = document.getElementById('schedule-name').value;
            const interval = document.getElementById('schedule-interval').value;
            const time = document.getElementById('schedule-time').value;
            const bm25Cache = document.getElementById('schedule-bm25').checked;
            
            if (!name.trim()) {
                alert('Bitte geben Sie einen Namen für den Zeitplan ein.');
                return;
            }
            
            if (interval === 'hourly' && !time) {
                alert('Bitte geben Sie eine Uhrzeit ein.');
                return;
            }
            
            let days = null;
            if (interval === 'weekly') {
                const selectedDays = Array.from(document.querySelectorAll('.schedule-day:checked'))
                    .map(checkbox => checkbox.value);
                if (selectedDays.length === 0) {
                    alert('Bitte wählen Sie mindestens einen Wochentag aus.');
                    return;
                }
                days = selectedDays.join(',');
            }
            
            const scheduleData = {
                name: name.trim(),
                interval: interval,
                time: time || null,
                days: days,
                enabled: true,
                config: {
                    bm25_cache: bm25Cache
                }
            };
            
            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Clear form
                    document.getElementById('schedule-form').reset();
                    document.getElementById('schedule-interval').value = 'daily';
                    document.getElementById('schedule-time').value = '02:00';
                    showWeeklyDays(); // Reset to daily view
                    
                    // Reload schedules
                    await loadSchedules();
                    
                    alert(result.message);
                } else {
                    const error = await response.json();
                    alert('Fehler beim Erstellen des Zeitplans: ' + error.detail);
                }
            } catch (error) {
                console.error('Error creating schedule:', error);
                alert('Fehler beim Erstellen des Zeitplans');
            }
        }

        async function toggleSchedule(scheduleId, enable) {
            try {
                const response = await fetch(`/api/schedules/${scheduleId}/toggle`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    await loadSchedules();
                    alert(result.message);
                } else {
                    const error = await response.json();
                    alert('Fehler beim Umschalten des Zeitplans: ' + error.detail);
                }
            } catch (error) {
                console.error('Error toggling schedule:', error);
                alert('Fehler beim Umschalten des Zeitplans');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Möchten Sie diesen Zeitplan wirklich löschen?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, { method: 'DELETE' });
                if (response.ok) {
                    const result = await response.json();
                    await loadSchedules();
                    alert(result.message);
                } else {
                    const error = await response.json();
                    alert('Fehler beim Löschen des Zeitplans: ' + error.detail);
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
                alert('Fehler beim Löschen des Zeitplans');
            }
        }

        function showWeeklyDays() {
            const interval = document.getElementById('schedule-interval').value;
            const weeklyDays = document.getElementById('weekly-days');
            const timeInput = document.getElementById('schedule-time');
            
            if (interval === 'weekly') {
                weeklyDays.style.display = 'block';
            } else if (interval === 'hourly') {
                weeklyDays.style.display = 'none';
                timeInput.disabled = true;
                timeInput.value = '';
            } else {
                weeklyDays.style.display = 'none';
                timeInput.disabled = false;
            }
        }

        // Event listeners for scheduling
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial schedule data
            loadSchedules();
            loadSchedulerStatus();
        });

        document.addEventListener('click', (e) => {
            // Scheduler control buttons
            if (e.target.closest('#start-scheduler-btn')) {
                e.preventDefault();
                startScheduler();
            }
            
            if (e.target.closest('#stop-scheduler-btn')) {
                e.preventDefault();
                stopScheduler();
            }
        });

        // Schedule form submission
        document.getElementById('schedule-form').addEventListener('submit', createSchedule);

        // Interval change handler
        document.getElementById('schedule-interval').addEventListener('change', showWeeklyDays);
    </script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.initLanguageDropdown) { window.initLanguageDropdown(); }
  });
</script>
</body>
</html>
