<!DOCTYPE html>
<html lang="{{ 'de' if ui_language == 'DE' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - Zammad Qdrant Interface</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js für interaktive Komponenten -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/static/lang.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        /* Custom animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <a href="/" class="flex items-center hover:text-blue-600 transition-colors">
                            <div class="flex-shrink-0">
                                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600 mr-2"></i>
                            </div>
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-lucide="database" class="w-8 h-8 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <h1 class="text-2xl font-bold text-gray-900">Zammad Qdrant Interface</h1>
                                    <p class="text-sm text-gray-600">Einstellungen</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Language Dropdown -->
                        <div class="flex items-center p-2 rounded-lg bg-gray-100">
                            <i data-lucide="globe" class="w-5 h-5 mr-2"></i>
                            <select id="ui-language-select" class="bg-transparent text-sm outline-none">
                                <option value="DE" {{ 'selected' if ui_language == 'DE' else '' }}>DE</option>
                                <option value="EN" {{ 'selected' if ui_language == 'EN' else '' }}>EN</option>
                            </select>
                        </div>
                        <!-- Theme Toggle -->
                        <button class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i data-lucide="moon" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Navigation zu KI-Einstellungen -->
            <div class="mb-8">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-white bg-opacity-20">
                                <i data-lucide="brain" class="w-8 h-8"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-xl font-semibold">KI-Features</h2>
                                <p class="text-sm text-purple-100">Automatische Ticket-Verarbeitung mit Ollama und RAG</p>
                            </div>
                        </div>
                        <a href="/ai-settings"
                           class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-lg transition-all duration-200 font-medium">
                            <i data-lucide="settings" class="w-5 h-5 inline mr-2"></i>
                            KI-Einstellungen
                        </a>
                    </div>
                </div>
            </div>

            <!-- Settings Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Zammad Configuration -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="p-3 rounded-full bg-green-100">
                            <i data-lucide="server" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-semibold text-gray-900">Zammad Konfiguration</h2>
                            <p class="text-sm text-gray-600">API-Verbindung zu Zammad</p>
                        </div>
                    </div>

                    <form class="space-y-4">
                        <!-- Zammad URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Zammad URL
                            </label>
                            <input type="url" 
                                   placeholder="https://your-zammad-instance.com"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Zammad API Token -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Zammad API Token
                            </label>
                            <input type="password" 
                                   placeholder="Ihr API-Token"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Connection Status -->
                        <div class="flex items-center justify-between" data-service="zammad">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                <span class="text-sm text-gray-600">Status wird geprüft...</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Qdrant Configuration -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="p-3 rounded-full bg-purple-100">
                            <i data-lucide="database" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-semibold text-gray-900">Qdrant Konfiguration</h2>
                            <p class="text-sm text-gray-600">Vector Database Verbindung</p>
                        </div>
                    </div>

                    <form class="space-y-4">
                        <!-- Qdrant URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Qdrant URL
                            </label>
                            <input type="url" 
                                   value="http://localhost:6333"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Qdrant API Token -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Qdrant API Token
                            </label>
                            <input type="password" 
                                   placeholder="Ihr API-Token (optional)"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </div>

                        <!-- Connection Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center" data-service="qdrant">
                                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                <span class="text-sm text-gray-600">Status wird geprüft...</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Maintenance Actions -->
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="p-3 rounded-full bg-orange-100">
                            <i data-lucide="wrench" class="w-6 h-6 text-orange-600"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-semibold text-gray-900">Wartung & Administration</h2>
                            <p class="text-sm text-gray-600">System-Wartung und Datenverwaltung</p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <!-- Clear BM25 Cache -->
                        <div class="flex-1 border border-red-200 rounded-lg p-4 flex flex-col">
                            <div class="flex items-center mb-3">
                                <i data-lucide="database" class="w-5 h-5 text-red-600 mr-2"></i>
                                <h3 class="text-sm font-medium text-gray-900">BM25 Cache löschen</h3>
                            </div>
                            <p class="text-xs text-gray-600 mb-4 flex-1">
                                Entfernt alle BM25-Cache-Dateien und zwingt zur Neuberechnung
                            </p>
                            <button class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors text-sm mt-auto">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                BM25 Cache löschen
                            </button>
                        </div>

                        <!-- Reset Qdrant Collection -->
                        <div class="flex-1 border border-orange-200 rounded-lg p-4 flex flex-col">
                            <div class="flex items-center mb-3">
                                <i data-lucide="rotate-ccw" class="w-5 h-5 text-orange-600 mr-2"></i>
                                <h3 class="text-sm font-medium text-gray-900">Qdrant Collection zurücksetzen</h3>
                            </div>
                            <p class="text-xs text-gray-600 mb-4 flex-1">
                                Löscht alle Daten und legt eine neue Collection an
                            </p>
                            <button class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors text-sm mt-auto">
                                <i data-lucide="rotate-ccw" class="w-4 h-4 inline mr-2"></i>
                                Collection zurücksetzen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Settings -->
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Einstellungen speichern</h2>
                            <p class="text-sm text-gray-600">Alle Konfigurationen persistent speichern</p>
                        </div>
                        <div class="flex space-x-3">
                            <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadSettings();
        });

        // Global variables
        let currentConfig = {};

        // Load settings from API
        async function loadSettings() {
            try {
                // Load config
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                currentConfig = config;
                
                // Populate form fields
                const zammadUrlField = document.querySelector('input[placeholder*="https://your-zammad-instance.com"]');
                const zammadTokenField = document.querySelector('input[placeholder*="API-Token"]');
                const qdrantUrlField = document.querySelector('input[value="http://localhost:6333"]');
                const qdrantTokenField = document.querySelector('input[placeholder*="API-Token (optional)"]');
                
                if (zammadUrlField) zammadUrlField.value = config.zammad_url || '';
                if (zammadTokenField) zammadTokenField.value = config.zammad_token || '';
                if (qdrantUrlField) qdrantUrlField.value = config.qdrant_url || 'http://localhost:6333';
                if (qdrantTokenField) qdrantTokenField.value = config.qdrant_api_key || '';
                
                // Check connection status
                await checkConnections();
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Check connection status
        async function checkConnections() {
            try {
                // Check Zammad
                const zammadResponse = await fetch('/api/zammad-status');
                const zammadStatus = await zammadResponse.json();
                updateConnectionStatus('zammad', zammadStatus);
                
                // Check Qdrant
                const qdrantResponse = await fetch('/api/qdrant-status');
                const qdrantStatus = await qdrantResponse.json();
                updateConnectionStatus('qdrant', qdrantStatus);
                
            } catch (error) {
                console.error('Error checking connections:', error);
            }
        }

        // Update connection status display
        function updateConnectionStatus(service, status) {
            const statusDiv = document.querySelector(`[data-service="${service}"]`);
            if (statusDiv) {
                const dot = statusDiv.querySelector('.w-3.h-3.rounded-full');
                const text = statusDiv.querySelector('span');
                
                if (status.status === 'connected') {
                    dot.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    text.textContent = 'Verbunden';
                    text.className = 'text-sm text-green-600';
                } else {
                    dot.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    text.textContent = 'Nicht verbunden';
                    text.className = 'text-sm text-red-600';
                }
            }
        }

        // Save settings
        async function saveSettings() {
            const zammadUrl = document.querySelector('input[placeholder*="https://your-zammad-instance.com"]').value;
            const zammadToken = document.querySelector('input[placeholder*="API-Token"]').value;
            const qdrantUrl = document.querySelector('input[value="http://localhost:6333"]').value;
            const qdrantToken = document.querySelector('input[placeholder*="API-Token (optional)"]').value;

            const config = {
                zammad_url: zammadUrl,
                zammad_token: zammadToken,
                qdrant_url: qdrantUrl,
                qdrant_api_key: qdrantToken,
                bm25_cache: currentConfig.bm25_cache || false,
                min_age_days: currentConfig.min_age_days || 14,
                start_date: currentConfig.start_date || '2018-01-01'
            };

            // Show loading state
            const saveButton = document.querySelector('button').closest('button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i> Speichere...';
            saveButton.disabled = true;

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    // Clear current config to force reload
                    currentConfig = {};
                    
                    // Wait a moment for the backend to save the file
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reload configuration from backend
                    await loadSettings();
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    successAlert.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>Einstellungen erfolgreich gespeichert!';
                    document.body.appendChild(successAlert);
                    
                    // Reinitialize icons for the alert
                    lucide.createIcons();
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);
                    
                } else {
                    const error = await response.json();
                    alert('Fehler beim Speichern: ' + (error.detail || 'Unbekannter Fehler'));
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Fehler beim Speichern der Einstellungen: ' + error.message);
            } finally {
                // Restore button state
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
                lucide.createIcons();
            }
        }

        // Clear BM25 cache
        async function clearBM25Cache(buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Lösche...';
            buttonElement.disabled = true;
            
            try {
                const response = await fetch('/api/bm25-cache-clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    successAlert.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>' + result.message;
                    document.body.appendChild(successAlert);
                    
                    lucide.createIcons();
                    
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);
                } else {
                    const error = await response.json();
                    alert('Fehler: ' + (error.detail || 'Unbekannter Fehler'));
                }
            } catch (error) {
                console.error('Error clearing BM25 cache:', error);
                alert('Fehler beim Löschen des BM25-Cache: ' + error.message);
            } finally {
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                lucide.createIcons();
            }
        }

        // Reset collection
        async function resetCollection(buttonElement) {
            // Show confirmation dialog
            if (!confirm('WARNUNG: Diese Aktion löscht ALLE Daten in der Qdrant Collection!\\n\\nMöchten Sie wirklich fortfahren?')) {
                return;
            }
            
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Zurücksetzen...';
            buttonElement.disabled = true;
            
            try {
                const response = await fetch('/api/collection-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    successAlert.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>' + result.message;
                    document.body.appendChild(successAlert);
                    
                    lucide.createIcons();
                    
                    setTimeout(() => {
                        successAlert.remove();
                    }, 5000);
                } else {
                    const error = await response.json();
                    alert('Fehler: ' + (error.detail || 'Unbekannter Fehler'));
                }
            } catch (error) {
                console.error('Error resetting collection:', error);
                alert('Fehler beim Zurücksetzen der Collection: ' + error.message);
            } finally {
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                lucide.createIcons();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // The data-service attributes are already in the HTML
        });

        document.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const buttonText = button.textContent.trim();
            
            if (buttonText.includes('Speichern')) {
                e.preventDefault();
                saveSettings();
            } else if (buttonText.includes('BM25 Cache löschen')) {
                e.preventDefault();
                clearBM25Cache(button);
            } else if (buttonText.includes('Collection zurücksetzen')) {
                e.preventDefault();
                resetCollection(button);
            }
        });
    </script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.initLanguageDropdown) { window.initLanguageDropdown(); }
  });
</script>
</body>
</html>
